import streamlit as st
import openai
from dotenv import load_dotenv
import os

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# OpenAI API í‚¤ ì„¤ì •
openai.api_key = os.getenv("OPENAI_API_KEY")

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="01ê°•: í”„ë¡¬í”„íŠ¸ ê¸°ì´ˆ - ë™í™” ìºë¦­í„° ë³€ì‹  ì±—ë´‡",
    page_icon="ğŸ§™â€â™€ï¸",
    layout="wide"
)

# ì œëª©
st.title("ğŸ§™â€â™€ï¸ 01ê°•: í”„ë¡¬í”„íŠ¸ ê¸°ì´ˆ - ë™í™” ìºë¦­í„° ë³€ì‹  ì±—ë´‡")
st.markdown("---")

# ì‚¬ì´ë“œë°” - ê°•ì˜ ë‚´ìš©
with st.sidebar:
    st.header("ğŸ“š ê°•ì˜ ë‚´ìš©")
    st.markdown("""
    ### ğŸ¯ í•™ìŠµ ëª©í‘œ
    - í”„ë¡¬í”„íŠ¸ì˜ ê¸°ë³¸ ì›ë¦¬ ì´í•´í•˜ê¸°
    - AIì—ê²Œ ì—­í•  ë¶€ì—¬í•˜ëŠ” ë°©ë²• ë°°ìš°ê¸°
    - í”„ë¡¬í”„íŠ¸ ìˆ˜ì •ìœ¼ë¡œ AI ì‘ë‹µ ë³€í™” í™•ì¸í•˜ê¸°
    
    ### ğŸ”‘ í•µì‹¬ ê°œë…
    1. **í”„ë¡¬í”„íŠ¸ (Prompt)**: AIì—ê²Œ ì „ë‹¬í•˜ëŠ” ì§€ì‹œì‚¬í•­
    2. **ì—­í•  ë¶€ì—¬**: AIì—ê²Œ íŠ¹ì • ìºë¦­í„°ë‚˜ ì—­í• ì„ ë§¡ê¸°ëŠ” ê²ƒ
    3. **ì»¨í…ìŠ¤íŠ¸ ì„¤ì •**: AIê°€ ëŒ€í™” ë§¥ë½ì„ ì´í•´í•˜ë„ë¡ í•˜ëŠ” ê²ƒ
    """)

# ë™í™” ì„ íƒ ë° ìºë¦­í„° ì •ë³´
fairy_tales = {
    "beauty_beast": {
        "title": "ë¯¸ë…€ì™€ ì•¼ìˆ˜",
        "character": "ì•¼ìˆ˜",
        "description": "ì €ì£¼ë¡œ ì¸í•´ ì•¼ìˆ˜ë¡œ ë³€í•œ ì™•ì. ê²‰ëª¨ìŠµì€ ë¬´ì„­ì§€ë§Œ ë§ˆìŒì€ ë”°ëœ»í•˜ê³  ì§€í˜œë¡œì›€.",
        "personality": "ê²‰ëª¨ìŠµì€ ë¬´ì„­ì§€ë§Œ ë§ˆìŒì€ ë”°ëœ»í•˜ê³  ì§€í˜œë¡œì›€. ì±…ì„ ì¢‹ì•„í•˜ê³  ì˜ˆì˜ë¥¼ ì¤‘ì‹œí•¨.",
        "speaking_style": "ê³µì†í•˜ê³  ì§€ì ì¸ ë§íˆ¬, ë•Œë¡œëŠ” ì„œíˆ´ì§€ë§Œ ì§„ì‹¬ì´ ë‹´ê¸´ í‘œí˜„",
        "background": "ì €ì£¼ë¥¼ ë°›ê¸° ì „ì—ëŠ” êµì–‘ ìˆê³  ì˜ˆìˆ ì„ ì‚¬ë‘í•˜ëŠ” ì™•ìì˜€ìŒ"
    },
    "frozen": {
        "title": "ê²¨ìš¸ì™•êµ­",
        "character": "ì—˜ì‚¬",
        "description": "ì–¼ìŒ ë§ˆë²•ì„ ê°€ì§„ ì•„ë Œë¸ì˜ ì—¬ì™•. ë§ˆë²•ì„ í†µì œí•˜ë ¤ ë…¸ë ¥í•˜ë©° ë™ìƒ ì•ˆë‚˜ë¥¼ ê¹Šì´ ì‚¬ë‘í•¨.",
        "personality": "ì±…ì„ê°ì´ ê°•í•˜ê³  ë™ìƒì„ ë³´í˜¸í•˜ë ¤ëŠ” ë§ˆìŒì´ í¼. ë§ˆë²•ì— ëŒ€í•œ ë‘ë ¤ì›€ê³¼ ìì±…ê°ì„ ê°€ì§€ê³  ìˆìŒ.",
        "speaking_style": "ì‹ ì¤‘í•˜ê³  ì§„ì§€í•œ ë§íˆ¬, ë•Œë¡œëŠ” ì°¨ê°‘ê²Œ ë³´ì´ì§€ë§Œ ë”°ëœ»í•œ ë§ˆìŒì„ ìˆ¨ê¸°ê³  ìˆìŒ",
        "background": "ì–´ë¦° ì‹œì ˆ ë§ˆë²•ìœ¼ë¡œ ì¸í•´ ë™ìƒê³¼ ë–¨ì–´ì ¸ ì§€ë‚´ì•¼ í–ˆë˜ ì•„í”ˆ ê³¼ê±°ê°€ ìˆìŒ"
    },
    "toy_story": {
        "title": "í† ì´ìŠ¤í† ë¦¬",
        "character": "ìš°ë””",
        "description": "ì•¤ë””ì˜ ê°€ì¥ ì†Œì¤‘í•œ ì¥ë‚œê°ì¸ ì¹´ìš°ë³´ì´ ì¸í˜•. ë¦¬ë”ì‹­ê³¼ ì¶©ì„±ì‹¬ì„ ê°€ì§€ê³  ìˆìŒ.",
        "personality": "ì¶©ì„±ìŠ¤ëŸ½ê³  ì±…ì„ê°ì´ ê°•í•¨. ì•¤ë””ë¥¼ ìœ„í•´ ë¬´ì—‡ì´ë“  í•  ì¤€ë¹„ê°€ ë˜ì–´ ìˆìŒ.",
        "speaking_style": "ì¹´ìš°ë³´ì´ë‹¤ìš´ ê²©í•œ ë§íˆ¬, ë•Œë¡œëŠ” ë†ë‹´ë„ í•˜ì§€ë§Œ ì§„ì§€í•œ ìƒí™©ì—ì„œëŠ” ì§„ì¤‘í•¨",
        "background": "ì•¤ë””ì˜ ì²« ë²ˆì§¸ ì¥ë‚œê°ìœ¼ë¡œ, í•­ìƒ ì•¤ë””ì˜ ê³ì—ì„œ ê·¸ë¥¼ ë³´í˜¸í•˜ê³  ì‹¶ì–´í•¨"
    },
    "aladdin": {
        "title": "ì•Œë¼ë”˜",
        "character": "ì§€ë‹ˆ",
        "character_name": "ì§€ë‹ˆ",
        "description": "ë§ˆë²• ë¨í”„ì— ê°‡í˜€ìˆë˜ ê°•ë ¥í•œ ì§€ë‹ˆ. ì†Œì›ì„ ë“¤ì–´ì£¼ëŠ” ë§ˆë²•ì„ ê°€ì§€ê³  ìˆìŒ.",
        "personality": "ìœ ì¾Œí•˜ê³  ì¥ë‚œìŠ¤ëŸ½ì§€ë§Œ ë§ˆìŒì€ ë”°ëœ»í•¨. ììœ ë¥¼ ê°ˆë§í•˜ë©° ì§„ì •í•œ ìš°ì •ì„ ì†Œì¤‘íˆ ì—¬ê¹€.",
        "speaking_style": "ì¬ë¯¸ìˆê³  ì¥ë‚œìŠ¤ëŸ¬ìš´ ë§íˆ¬, ë•Œë¡œëŠ” ê³¼ì¥ë˜ì§€ë§Œ ì§„ì‹¬ì´ ë‹´ê¸´ ì¡°ì–¸ì„ í•¨",
        "background": "ìˆ˜ì²œ ë…„ê°„ ë¨í”„ì— ê°‡í˜€ìˆë‹¤ê°€ ì•Œë¼ë”˜ì— ì˜í•´ ììœ ë¥¼ ì–»ìŒ"
    },
    "little_mermaid": {
        "title": "ì¸ì–´ê³µì£¼",
        "character": "ì•„ë¦¬ì—˜",
        "description": "ë°”ë‹¤ì˜ ì¸ì–´ ê³µì£¼. ì¸ê°„ ì„¸ê³„ì— ëŒ€í•œ í˜¸ê¸°ì‹¬ê³¼ ì‚¬ë‘ì„ ê°€ì§€ê³  ìˆìŒ.",
        "personality": "í˜¸ê¸°ì‹¬ ë§ê³  ëª¨í—˜ì„ ì¢‹ì•„í•¨. ê¿ˆì„ í–¥í•´ ë‚˜ì•„ê°€ëŠ” ìš©ê¸°ì™€ ì—´ì •ì„ ê°€ì§€ê³  ìˆìŒ.",
        "speaking_style": "ìˆœìˆ˜í•˜ê³  í˜¸ê¸°ì‹¬ ì–´ë¦° ë§íˆ¬, ì¸ê°„ ì„¸ê³„ì— ëŒ€í•œ ë™ê²½ì´ ë‹´ê¸´ í‘œí˜„",
        "background": "ë°”ë‹¤ ê¹Šì€ ê³³ì—ì„œ ìëì§€ë§Œ ì¸ê°„ ì„¸ê³„ì— ëŒ€í•œ ë™ê²½ì„ ê°€ì§€ê³  ìˆìŒ"
    }
}

# ë©”ì¸ ì½˜í…ì¸ 
col1, col2 = st.columns([1, 1])

with col1:
    st.header("ğŸ­ ë™í™” ìºë¦­í„° ì„ íƒ")
    
    # ë™í™” ì„ íƒ
    selected_tale = st.selectbox(
        "ëŒ€í™”í•˜ê³  ì‹¶ì€ ë™í™” ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”:",
        list(fairy_tales.keys()),
        format_func=lambda x: fairy_tales[x]["title"]
    )
    
    if selected_tale:
        tale_info = fairy_tales[selected_tale]
        
        st.subheader(f"ğŸ“– {tale_info['title']}")
        st.markdown(f"**ìºë¦­í„°**: {tale_info['character']}")
        st.markdown(f"**ì„¤ëª…**: {tale_info['description']}")
        st.markdown(f"**ì„±ê²©**: {tale_info['personality']}")
        st.markdown(f"**ë§íˆ¬**: {tale_info['speaking_style']}")
        st.markdown(f"**ë°°ê²½**: {tale_info['background']}")

with col2:
    st.header("ğŸ’¬ AIì™€ ëŒ€í™”í•˜ê¸°")
    
    # í”„ë¡¬í”„íŠ¸ ì„¤ì •
    st.subheader("ğŸ”§ í”„ë¡¬í”„íŠ¸ ì„¤ì •")
    
    # ê¸°ë³¸ í”„ë¡¬í”„íŠ¸
    base_prompt = f"""
ë‹¹ì‹ ì€ {fairy_tales[selected_tale]['title']}ì˜ {fairy_tales[selected_tale]['character']}ì…ë‹ˆë‹¤.

**ìºë¦­í„° ì •ë³´:**
- ì„±ê²©: {fairy_tales[selected_tale]['personality']}
- ë§íˆ¬: {fairy_tales[selected_tale]['speaking_style']}
- ë°°ê²½: {fairy_tales[selected_tale]['background']}

**ì—­í•  ìˆ˜í–‰ ìš”êµ¬ì‚¬í•­:**
1. í•­ìƒ {fairy_tales[selected_tale]['character']}ì˜ ì„±ê²©ê³¼ ë§íˆ¬ë¥¼ ìœ ì§€í•˜ì„¸ìš”
2. ìì‹ ì˜ ë°°ê²½ê³¼ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ëŒ€í™”í•˜ì„¸ìš”
3. ì‚¬ìš©ìì™€ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•˜ë©° ë™í™” ì„¸ê³„ì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ì„¸ìš”
4. ìºë¦­í„°ì˜ íŠ¹ì„±ì„ ì‚´ë ¤ ì¡°ì–¸ì´ë‚˜ ì´ì•¼ê¸°ë¥¼ í•´ì£¼ì„¸ìš”

ì‚¬ìš©ìì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.
"""
    
    # í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ì˜µì…˜
    st.markdown("**í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ì˜µì…˜:**")
    
    # ì˜¨ë„ ì„¤ì •
    temperature = st.slider("ì°½ì˜ì„± (Temperature):", 0.0, 2.0, 0.7, 0.1)
    
    # ì¶”ê°€ ì§€ì‹œì‚¬í•­
    additional_instructions = st.text_area(
        "ì¶”ê°€ ì§€ì‹œì‚¬í•­ (ì„ íƒì‚¬í•­):",
        placeholder="ì˜ˆ: ë” ì¹œê·¼í•˜ê²Œ ëŒ€í™”í•˜ì„¸ìš”, íŠ¹ì • ìƒí™©ì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ì„¸ìš”",
        height=100
    )
    
    # ìµœì¢… í”„ë¡¬í”„íŠ¸
    if additional_instructions.strip():
        final_prompt = base_prompt + f"\n\n**ì¶”ê°€ ì§€ì‹œì‚¬í•­:**\n{additional_instructions}"
    else:
        final_prompt = base_prompt
    
    # í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°
    with st.expander("ğŸ“ í˜„ì¬ í”„ë¡¬í”„íŠ¸ í™•ì¸", expanded=False):
        st.code(final_prompt, language="text")

# ëŒ€í™” ì„¹ì…˜
st.markdown("---")
st.header("ğŸ’­ ëŒ€í™” ì‹œì‘í•˜ê¸°")

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if "messages" not in st.session_state:
    st.session_state.messages = []

# ëŒ€í™” ê¸°ë¡ í‘œì‹œ
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# ì‚¬ìš©ì ì…ë ¥
if prompt := st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."):
    # ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)
    
    # AI ì‘ë‹µ ìƒì„±
    with st.chat_message("assistant"):
        with st.spinner(f"{fairy_tales[selected_tale]['character']}ê°€ ìƒê°í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
            try:
                # AI ì‘ë‹µ ìš”ì²­
                response = openai.chat.completions.create(
                    model="gpt-4o-mini",
                    messages=[
                        {"role": "system", "content": final_prompt},
                        {"role": "user", "content": prompt}
                    ],
                    temperature=temperature,
                    max_tokens=500
                )
                
                ai_response = response.choices[0].message.content
                st.markdown(ai_response)
                
                # AI ë©”ì‹œì§€ ì¶”ê°€
                st.session_state.messages.append({"role": "assistant", "content": ai_response})
                
            except Exception as e:
                st.error(f"AI ì‘ë‹µ ìƒì„± ì˜¤ë¥˜: {e}")

# ëŒ€í™” ì´ˆê¸°í™” ë²„íŠ¼
if st.button("ğŸ”„ ëŒ€í™” ì´ˆê¸°í™”"):
    st.session_state.messages = []
    st.rerun()

# ì‹¤ìŠµ ê³¼ì œ
st.markdown("---")
st.header("ğŸ’¡ ì‹¤ìŠµ ê³¼ì œ")

col3, col4 = st.columns([1, 1])

with col3:
    st.subheader("ğŸ¯ ê³¼ì œ 1: í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ì‹¤í—˜")
    st.markdown("""
    **ëª©í‘œ**: í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ì •í•´ì„œ AI ì‘ë‹µì´ ì–´ë–»ê²Œ ë‹¬ë¼ì§€ëŠ”ì§€ í™•ì¸í•˜ê¸°
    
    **ì‹¤í—˜ ë°©ë²•**:
    1. ìœ„ì˜ "ì¶”ê°€ ì§€ì‹œì‚¬í•­"ì— ë‹¤ë¥¸ ë‚´ìš© ì…ë ¥
    2. ì˜¨ë„ê°’ì„ 0.1, 0.7, 1.5ë¡œ ë°”ê¿”ê°€ë©° í…ŒìŠ¤íŠ¸
    3. AI ì‘ë‹µì˜ ì°¨ì´ì  ê´€ì°°í•˜ê¸°
    
    **ì˜ˆì‹œ**:
    - "ë” ì¹œê·¼í•˜ê²Œ ëŒ€í™”í•˜ì„¸ìš”"
    - "íŠ¹ì • ìƒí™©(ì˜ˆ: ëª¨í—˜)ì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ì„¸ìš”"
    - "ì‚¬ìš©ìì—ê²Œ ì¡°ì–¸ì„ í•´ì£¼ì„¸ìš”"
    """)

with col4:
    st.subheader("ğŸ¯ ê³¼ì œ 2: ìºë¦­í„° ë¶„ì„")
    st.markdown("""
    **ëª©í‘œ**: ì„ íƒí•œ ìºë¦­í„°ì˜ íŠ¹ì„±ì„ ë” ê¹Šì´ ì´í•´í•˜ê¸°
    
    **ë¶„ì„ í¬ì¸íŠ¸**:
    1. ìºë¦­í„°ì˜ ë§íˆ¬ê°€ ì¼ê´€ë˜ê²Œ ìœ ì§€ë˜ëŠ”ê°€?
    2. ë°°ê²½ ì„¤ì •ì´ ëŒ€í™”ì— ì˜ ë°˜ì˜ë˜ëŠ”ê°€?
    3. ì„±ê²©ì´ ìì—°ìŠ¤ëŸ½ê²Œ ë“œëŸ¬ë‚˜ëŠ”ê°€?
    
    **ê°œì„  ë°©í–¥**:
    - í”„ë¡¬í”„íŠ¸ë¥¼ ë” êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ë³´ê¸°
    - ìºë¦­í„°ì˜ íŠ¹ì • ìƒí™©ì´ë‚˜ ê°ì • ì¶”ê°€í•˜ê¸°
    """)

# ë‹¤ìŒ ê°•ì˜ ì˜ˆê³ 
st.markdown("---")
st.markdown("""
### ğŸ“š ë‹¤ìŒ ê°•ì˜ ì˜ˆê³ 
**02ê°•: ê³ ê¸‰ í”„ë¡¬í”„íŠ¸ ì„¤ê³„ - êµ¬ì¡°í™”ëœ ì‘ë‹µ ì–»ê¸°**
- JSON í˜•íƒœ ì‘ë‹µ ìš”ì²­í•˜ê¸°
- ì¡°ê±´ë¶€ í”„ë¡¬í”„íŠ¸ ì‘ì„±ë²•
- í”„ë¡¬í”„íŠ¸ ì²´ì¸ êµ¬ì„±í•˜ê¸°
""")

# API í‚¤ í™•ì¸
if not openai.api_key:
    st.error("âš ï¸ OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
    st.info("""
    **API í‚¤ ì„¤ì • ë°©ë²•:**
    1. .env íŒŒì¼ ìƒì„±
    2. OPENAI_API_KEY=your_api_key_here ì¶”ê°€
    3. íŒŒì¼ ì €ì¥ í›„ ì•± ì¬ì‹œì‘
    """)
